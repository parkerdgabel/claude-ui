{% extends "base.html" %}

{% block title %}Instances - Claude UI{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Claude Code Instances
            </h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Manage active Claude Code instances
            </p>
        </div>
        <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
                onclick="showCreateInstanceModal()">
            <i data-lucide="plus" class="mr-2 h-4 w-4"></i>
            New Instance
        </button>
    </div>
    
    <!-- Instances List -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <ul class="divide-y divide-gray-200" id="instances-list">
            <!-- Instances will be loaded here -->
            <li class="px-6 py-12 text-center">
                <i data-lucide="activity" class="mx-auto h-12 w-12 text-gray-400"></i>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No active instances</h3>
                <p class="mt-1 text-sm text-gray-500">Create a new instance to start using Claude Code.</p>
            </li>
        </ul>
    </div>
</div>

<script>
    async function loadInstances() {
        try {
            const response = await fetch('/api/instances');
            const instances = await response.json();
            
            const list = document.getElementById('instances-list');
            
            if (instances.length === 0) {
                return;
            }
            
            list.innerHTML = instances.map(instance => `
                <li class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full ${
                                    instance.status === 'active' ? 'bg-green-100' : 
                                    instance.status === 'error' ? 'bg-red-100' : 'bg-gray-100'
                                }">
                                    <i data-lucide="terminal" class="h-5 w-5 ${
                                        instance.status === 'active' ? 'text-green-600' : 
                                        instance.status === 'error' ? 'text-red-600' : 'text-gray-600'
                                    }"></i>
                                </span>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    ${instance.name}
                                </div>
                                <div class="text-sm text-gray-500">
                                    Status: <span class="${
                                        instance.status === 'active' ? 'text-green-600' : 
                                        instance.status === 'error' ? 'text-red-600' : 'text-gray-600'
                                    }">${instance.status}</span>
                                    ${instance.project_id ? ' â€¢ Project: ' + instance.project_id : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${instance.status === 'active' ? `
                                <a href="/instances/${instance.id}/chat" 
                                   class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                                    <i data-lucide="message-square" class="mr-1 h-3 w-3"></i>
                                    Chat
                                </a>
                            ` : ''}
                            <button onclick="toggleInstance('${instance.id}')" 
                                    class="inline-flex items-center px-3 py-1 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                ${instance.status === 'active' ? 'Stop' : 'Start'}
                            </button>
                            <button onclick="deleteInstance('${instance.id}')" 
                                    class="inline-flex items-center px-3 py-1 border border-gray-300 text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                                Delete
                            </button>
                        </div>
                    </div>
                </li>
            `).join('');
            
            lucide.createIcons();
            
        } catch (error) {
            console.error('Failed to load instances:', error);
        }
    }
    
    function showCreateInstanceModal() {
        // TODO: Implement modal
        alert('Create instance modal not implemented yet');
    }
    
    async function toggleInstance(instanceId) {
        // TODO: Implement start/stop
        alert('Toggle instance not implemented yet');
    }
    
    async function deleteInstance(instanceId) {
        if (!confirm('Are you sure you want to delete this instance?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/instances/${instanceId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadInstances();
            }
        } catch (error) {
            console.error('Failed to delete instance:', error);
        }
    }
    
    // Load instances on page load
    document.addEventListener('DOMContentLoaded', loadInstances);
    
    // Refresh every 10 seconds
    setInterval(loadInstances, 10000);
</script>
{% endblock %}